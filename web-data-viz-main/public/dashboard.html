<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Perfil Psicológico Anime</title>

    <link rel="stylesheet" href="./css/dashboard-anime.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  </head>

  <body>
    <div class="janela">
      <!-- MENU LATERAL -->
      <aside class="menu">
        <h1 class="logo">ANIPSI</h1>

        <div class="usuario">
          <p>Olá, <span id="b_usuario">Usuário</span>!</p>
        </div>

        <nav class="links">
          <a class="ativo">Dashboard</a>
          <a href="teste-personalidade.html">Teste de Personalidade</a>
          <a href="#" onclick="logout()">Sair</a>
        </nav>
      </aside>

      <!-- ÁREA PRINCIPAL -->
      <main class="conteudo">
        <h1 class="titulo">Análise do Seu Perfil Psicológico</h1>

        <!-- KPIS -->
        <div class="kpis">
          <div class="kpi">
            <h3>Traço Dominante</h3>
            <p id="kpiDominante">—</p>
          </div>

          <div class="kpi">
            <h3>Compatibilidade Máxima</h3>
            <p id="kpiCompatibilidade">—%</p>
          </div>

          <div class="kpi">
            <h3>Média Geral Psicológica</h3>
            <p id="kpiMedia">—</p>
          </div>

          <div class="kpi">
            <h3>Top 3 Afinidades</h3>
            <p id="kpiTop3">—</p>
          </div>
        </div>

        <!-- GRÁFICOS -->
        <section class="graficos">
          <div class="grafico-box">
            <h2>Perfil Psicológico (Radar)</h2>
            <canvas id="graficoRadar"></canvas>
          </div>

          <div class="grafico-box">
            <h2>Ranking de Compatibilidade com Personagens</h2>
            <canvas id="graficoBarra"></canvas>
          </div>
        </section>
      </main>
    </div>
  </body>
</html>

<script>
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  // fetch("/teste/listar").then(async function (res) {
  //   if (res.ok) {
  //     var obj = await res.json();
  //     console.log(obj);
  //     montaRadar(obj);
  //   } else {
  //     console.log("Erro ao carregar gráfico.");
  //   }
  // });

  fetch("/teste/listar").then(function (res) {
    if (res.ok) {
      res.json().then(function (response) {
        console.log(`Dados recebidos: ${JSON.stringify(response)}`);
        montaRadar(response);
      });
    } else {
      console.log("Erro ao carregar gráfico.");
    }
  });

  // KPIS ----------------------------------------
  kpiDominante.innerHTML = "Controle Emocional";
  kpiCompatibilidade.innerHTML = "82%";
  kpiMedia.innerHTML = "12.6";
  kpiTop3.innerHTML = "Maki, Shinobu, Megumi";

  // GRÁFICO RADAR --------------------------------

  function montaRadar(dados) {
    var ctxRadar = document.getElementById("graficoRadar");

    new Chart(ctxRadar, {
      type: "radar",
      data: {
        labels: [
          "Resiliência",
          "Confiança",
          "Estratégia",
          "Controle Emocional",
          "Impulsividade",
        ],
        datasets: [
          {
            label: "Meu Perfil",
            data: [
              dados[0].resiliencia,
              dados[0].confianca,
              dados[0].estrategia,
              dados[0].controle_emocional,
              dados[0].impulsividade,
            ],
            borderColor: "#b65df5",
            backgroundColor: "rgba(182, 93, 245, 0.25)",
            borderWidth: 2,
            pointBackgroundColor: "#ffffff",
            pointBorderColor: "#b65df5",
            pointRadius: 3,
          },
        ],
      },
      plugins: [ChartDataLabels],
      options: {
        scales: {
          r: {
            min: 0,
            max: 100,
            ticks: {
              display: false,
            },
            grid: {
              color: "rgba(255,255,255,0.1)",
              lineWidth: 2,
            },
            pointLabels: {
              color: "#fff",
              font: {
                size: 16,
                family: "Bangers",
              },
            },
          },
        },

        // POSICIONA OS VALORES NAS PONTAS
        plugins: {
          datalabels: {
            color: "#FFF",
            font: {
              size: 25,
              family: "Bangers",
            },
            formatter: function (value) {
              return value;
            },
            align: "start",
            offset: 8,
          },
        },
      },
    });
  }

  // BARRA — ranking de personagens --------------
  var ctxBarra = document.getElementById("graficoBarra");

  new Chart(ctxBarra, {
    type: "bar",
    data: {
      labels: [
        "Maki Zenin",
        "Shinobu Kochou",
        "Megumi Fushiguro",
        "Tanjiro",
        "Nobara Kugisaki",
      ],
      datasets: [
        {
          label: "Compatibilidade (%)",
          data: [82, 78, 66, 59, 54],
          backgroundColor: "#b65df5",
        },
      ],
    },
  });
</script>
